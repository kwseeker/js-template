# 浏览器页面渲染原理

资料很多，这里列举几个：

+ [渲染页面：浏览器的工作原理](https://developer.mozilla.org/zh-CN/docs/Web/Performance/Guides/How_browsers_work) (MDN)
+ [浏览器渲染原理](https://blog.xiayuxuan.cn/posts/2024/03/31%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86.html)


总结，主要分为下面流程（这里不关注请求处理、请求数据包结构）：

1. 获取页面 HTML 文件；HTML 中包含页面元素、还可能包含 CSS、JavaScript 元素；

  渲染到屏幕上面之前，HTML、CSS、JavaScript 必须被解析完成。

2. 解析 HTML 标记构建 DOM 树并下载 CSS、 JS、 web 字体等资源；

  解析 HTML 文件时是从自上而下、逐行进行的，因为渲染流程（这里包括解析、渲染）是单线程执行的（浏览器为当前页面分配一个主线程）。

  碰到 `<script>` 标签会暂停 HTML 解析，转交给浏览器引擎执行， 因为 JS 可能会改变 DOM 树结构。
  携带async属性的script标签，其脚本下载不会暂停 HTML 解析，下载完成后还是会暂停 HTML 解析。

  JS 脚本用于修改 DOM （比如直接修改 DOM、 通过绑定事件并监听事件动态修改等，修改包括 DOM 元素增删修改、样式修改等等）。

  CSS 不会阻塞 HTML 的解析，因为 CSS 样式是在后面渲染阶段才会用到。

3. 构建 CSSOM 树；

  CSS 的解析和 CSSOM 树的构建可以被异步执行。

4. 在 DOM、CSSOM 准备好后，执行渲染步骤，包括样式、布局、绘制，某些情况下还包括合成（合成主要是在合成线程中处理）。

  渲染步骤主要就是将 CSSOM 树和 DOM 树组合成一个渲染树（Render Tree），然后用于计算每个可见元素的布局，然后将其绘制到屏幕上。

  样式计算：
  将 DOM 和 CSSOM 组合成渲染树。计算样式树或渲染树的构建从 DOM 树的根开始，遍历每个可见节点。将所有相关样式与 DOM 树中的每个可见节点匹配起来，并根据 [CSS 级联](https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_cascade/Cascade)，确定每个节点的计算样式。

  布局：
  在渲染树上运行布局以计算每个节点的几何体。布局是确定呈现树中所有节点的尺寸和位置，以及确定页面上每个对象的大小和位置的过程。
  重排是后续过程中对页面的任意部分或整个文档的大小和位置的重新计算。

  绘制：
  关键渲染路径中的最后一步是将各个节点绘制到屏幕上，其中第一次的绘制被称为首次有意义的绘制。在绘制或光栅化阶段，浏览器将在布局阶段计算的每个盒子转换为屏幕上的实际像素。绘制涉及将元素的每个可见部分绘制到屏幕上，包括文本、颜色、边框、阴影以及按钮和图像等替换元素。浏览器需要以超快的速度执行这个过程。

  合成：
  当文档的各个部分以不同的层绘制，相互重叠时，必须进行合成，以确保它们以正确的顺序绘制到屏幕上，并正确显示内容。

5. 当页面懒加载或通过事件改变后还会涉及到重排（Reflow）和重绘（Repaint）。

  为了避免连续多次的操作导致布局树反复计算，浏览器会合并这些操作，当 JS 代码全部完成后再统一计算。所以，改动属性造成的 reflow 是异步完成的。

  reflow 一定会引起 repaint。

